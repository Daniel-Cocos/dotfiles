#!/usr/bin/env sh
MODE="$1"
STATE_FILE="/tmp/waybar_current_player"

players="$(playerctl -l 2>/dev/null | sed '/^$/d')"
if [ -z "$players" ]; then
  printf '{"text":"","class":"hidden"}'
  exit 0
fi

preferred="ytmdesktop chromium brave brave-browser brave-browser.desktop chrome"
ordered=""
for p in $preferred; do
  match="$(echo "$players" | grep -m1 "^$p")"
  [ -n "$match" ] && ordered="$ordered $match"
done
for p in $players; do
  echo "$ordered" | grep -qw "$p" || ordered="$ordered $p"
done

players="$(echo $ordered)"
set -- $players
if [ $# -eq 0 ]; then
  set -- $players
fi
num_players=$#

if [ -f "$STATE_FILE" ]; then
  idx="$(cat "$STATE_FILE" 2>/dev/null || echo 1)"
else
  idx=1
fi

case "$idx" in
  ''|*[!0-9]*)
    idx=1
    ;;
esac
if [ "$idx" -gt "$num_players" ] || [ "$idx" -lt 1 ]; then
  idx=1
fi

i=1
PLAYER=""
for p in "$@"; do
  if [ "$i" -eq "$idx" ]; then
    PLAYER="$p"
    break
  fi
  i=$((i+1))
done

get_meta() {
  key="$1"
  playerctl --player="$PLAYER" metadata "$key" 2>/dev/null || echo ""
}

status="$(playerctl --player="$PLAYER" status 2>/dev/null || echo "")"

case "$MODE" in
  cur)
    title="$(get_meta xesam:title)"
    artist="$(get_meta xesam:artist)"
    artist="$(printf '%s' "$artist" | sed -E 's/^\((.*)\)$/\1/; s/^ +//; s/ +$//')"
    [ -n "$title" ] || title="Unknown"
    icon=""
    echo "$status" | grep -q "Playing" && icon=""
    tooltip="$title"
    [ -n "$artist" ] && tooltip="$title - $artist"
    tooltip="$(printf '%s' "$tooltip" | sed 's/"/\\"/g')"
    short_player="$(printf '%s' "$PLAYER" | sed 's/\..*$//')"
    tooltip="[$short_player] $tooltip"
    printf '{"text":"%s","tooltip":"%s"}' "$icon" "$tooltip"
    ;;
  prev)
    prev="$(playerctl --player="$PLAYER" metadata --format '{{xesam:title}} - {{xesam:artist}}' 2>/dev/null || echo "")"
    cur="$(playerctl --player="$PLAYER" metadata --format '{{xesam:title}} - {{xesam:artist}}' 2>/dev/null || echo "")"
    if [ -z "$prev" ] || [ "$prev" = "$cur" ]; then
      prev="Not available"
    fi
    prev="$(printf '%s' "$prev" | sed 's/"/\\"/g')"
    printf '{"text":"","tooltip":"%s"}' "$prev"
    ;;
  next)
    next="$(playerctl --player="$PLAYER" metadata --format '{{xesam:title}} - {{xesam:artist}}' 2>/dev/null || echo "")"
    cur="$(playerctl --player="$PLAYER" metadata --format '{{xesam:title}} - {{xesam:artist}}' 2>/dev/null || echo "")"
    if [ -z "$next" ] || [ "$next" = "$cur" ]; then
      next="Not available"
    fi
    next="$(printf '%s' "$next" | sed 's/"/\\"/g')"
    printf '{"text":"%s","tooltip":"%s"}' "" "$next"
    ;;
  do-prev)
    playerctl --player="$PLAYER" previous
    printf '{"text":"","class":"hidden"}'
    ;;
  do-next)
    playerctl --player="$PLAYER" next
    printf '{"text":"","class":"hidden"}'
    ;;
  do-toggle)
    playerctl --player="$PLAYER" play-pause
    printf '{"text":"","class":"hidden"}'
    ;;
  cycle)
    idx=$((idx + 1))
    [ "$idx" -gt "$num_players" ] && idx=1
    echo "$idx" > "$STATE_FILE"
    printf '{"text":"","class":"hidden"}'
    ;;
  *)
    printf '{"text":"","class":"hidden"}'
    ;;
esac
